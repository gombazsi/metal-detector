<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fémdetektor</title>

  <style>
    body {
      background: #000;
      color: #0f0;
      font-family: monospace;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      user-select: none;
      text-align: center;
      transition: background 0.08s;
      /* Flash effect */
    }

    body.flash {
      background: #030;
    }

    h2 {
      margin-bottom: 10px;
    }

    #radar {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .circle {
      width: 260px;
      height: 260px;
      border-radius: 50%;
      border: 2px solid #0f0;
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 20px #0f05 inset;

      background-image: linear-gradient(rgba(0, 255, 0, .7) .1em, transparent .1em),
        linear-gradient(90deg, rgba(0, 255, 0, .7) .1em, transparent .1em);
      background-size: 20px 20px;
      background-position: center;
    }

    .sweep {
      position: absolute;
      width: 50%;
      left: calc(50% - 5px);
      height: 10px;
      background: rgba(0, 255, 0, .8);
      top: 50%;
      transform-origin: 0% 50%;
      animation: spin 2s linear infinite;
      box-shadow: 0 0 10px #0f0;
      border-radius: 5px;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .pulse {
      position: absolute;
      width: 260px;
      height: 260px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(0, 255, 0, 1) 0%, rgba(0, 255, 0, 0) 100%);
      opacity: 0;
      animation: pulse 2s infinite;
      pointer-events: none;
    }

    @keyframes pulse {
      0% {
        opacity: .2;
        transform: scale(.5);
      }

      100% {
        opacity: 0;
        transform: scale(1.4);
      }
    }

    #signalBar {
      height: 12px;
      width: 80%;
      margin: auto;
      background: rgba(0, 100, 0, .4);
      border: 1px solid #0f0;
      margin-bottom: 5px;
    }

    #signalFill {
      height: 100%;
      width: 0%;
      background: #0f0;
      box-shadow: 0 0 8px #0f0;
      transition: width .15s;
    }

    #strengthText {
      margin-bottom: 18px;
      width: 100%;
    }

    button {
      margin: auto;
      font-size: 22px;
      padding: 16px;
      width: 90%;
      background: black;
      border: 2px solid #0f0;
      color: #0f0;
    }

    button:active {
      background: #030;
    }

    #signalBar,
    #strengthText {
      display: none;
    }
  </style>
</head>

<body id="body">

  <h2>Fémdetektor</h2>
  <button id="copyFlags" onclick="copyFlags()">DETEKTOR BEKAPCSOLÁSA</button>
  <button id="startSearch" onclick="start()">KERESÉS INDÍTÁSA</button>

  <div id="radar">
    <div class="circle">
      <div class="sweep"></div>
      <div class="pulse" id="pulse"></div>
    </div>
  </div>

  <div id="signalBar">
    <div id="signalFill"></div>
  </div>
  <div id="strengthText">Jelerősség: 0%</div>

  <script>
    let device;
    let lastRSSI = -100;
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function copyFlags() {
      const text = "chrome://flags/#enable-web-bluetooth-new-permissions-backend";
      navigator.clipboard.writeText(text);
      alert("Link kimásolva, írd be a böngésződ címsorába és engedélyezd a detektor funkciókat!");
    }

    const bleSupported =
      navigator.bluetooth &&
      typeof BluetoothDevice !== "undefined" &&
      BluetoothDevice.prototype.watchAdvertisements;

    if (bleSupported) {
      document.getElementById("copyFlags").style.display = "none";
      document.getElementById("startSearch").style.display = "block";
    }
    else{      
      document.getElementById("copyFlags").style.display = "block";
      document.getElementById("startSearch").style.display = "none";
    }

    function rssiToScore(rssi) {
      return Math.max(0, Math.min(100, Math.round(((rssi + 100) / 60) * 100)));
    }

    function beep(score) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.frequency.value = 400 + score * 4;
      gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.12);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.12);
    }

    function flash() {
      const body = document.getElementById("body");
      body.classList.add("flash");
      setTimeout(() => body.classList.remove("flash"), 80);
    }

    // Continuous beep loop — independent from BLE events
    function scheduleBeep() {
      const score = rssiToScore(lastRSSI);

      // Convert score to delay
      const minDelay = 120;   // fastest
      const maxDelay = 1800;  // slowest
      const delay = maxDelay - (score / 100) * (maxDelay - minDelay);

      // Only beep if signal is meaningful
      if (score > 5) {
        beep(score);
        flash();
      }

      document.getElementById("signalFill").style.width = score + "%";
      document.getElementById("strengthText").innerText = `Jelerősség: ${score}%`;

      setTimeout(scheduleBeep, delay);
    }

    // Start the timed beep system
    scheduleBeep();

    async function start() {

      await audioCtx.resume(); // MOBILE FIX ✅

      try {
        device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [],
        });

        await device.watchAdvertisements();

        device.addEventListener("advertisementreceived", e => {
          lastRSSI = e.rssi;
        });

      } catch (err) {
        alert("Bluetooth error:\n" + err);
        console.error(err);
      }
    }
  </script>

</body>

</html>